{% extends "base.html" %}

{% block extra_styles %}
<style>
  /* ── Inputs globais (usados em forms do index) ── */
  input {
    width: 100%;
    padding: 0.6rem 0.85rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.86rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    margin-bottom: 0.75rem;
  }

  input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-dim);
  }

  input::placeholder {
    color: var(--muted);
  }
</style>
{% endblock %}

{% block content %}
<div class="app-main">

  <!-- CASO 1: USUÁRIO NÃO ESTÁ NA FILA -->
  {% if not user_entry %}
  <div class="fora-card">
    <p>Você não está na fila no momento.</p>
    <form action="{{ url_for('join_queue') }}" method="POST">
      <button type="submit" class="btn-entrar">ENTRAR NA FILA</button>
    </form>
  </div>
  {% endif %}

  <!-- CASO 2: AGUARDANDO -->
  {% if user_entry and user_entry.status == 'Disponível' %}

  {% if turn_user and turn_user.user_id == current_user.id %}

  <!-- É A SUA VEZ -->
  <div class="vez-card">
    <div class="card-chip chip-green">▶ É A SUA VEZ</div>
    <div class="card-name">{{ current_user.username }}</div>
    <div class="btn-row">
      <form action="{{ url_for('start_task') }}" method="POST">
        <button type="submit" class="btn-green">INICIAR</button>
      </form>
      <form action="{{ url_for('skip_task') }}" method="POST">
        <button type="submit" class="btn-skip">PULAR</button>
      </form>
    </div>
  </div>

  <div class="popup show" id="popup-turn">
    <button class="popup-close" onclick="this.parentElement.classList.remove('show')">×</button>
    <div class="popup-title">▶ SUA VEZ</div>
    <div class="popup-msg">É a sua vez! Clique em Iniciar para começar.</div>
  </div>

  {% else %}

  <!-- AGUARDANDO -->
  {% set posicao = namespace(value=0) %}
  {% for entry in queue %}
  {% if entry.user_id == current_user.id %}
  {% set posicao.value = loop.index %}
  {% endif %}
  {% endfor %}

  <div class="aguard-card">
    <div>
      <div class="sec-title" style="margin-bottom:0.18rem">Posição na fila</div>
      <div style="font-size:0.72rem; color:var(--muted)">Aguardando sua vez</div>
    </div>
    <div>
      <div class="pos-num">{{ posicao.value }}°<small>na fila</small></div>
    </div>
  </div>

  <div style="text-align:center">
    <form action="{{ url_for('leave_queue') }}" method="POST">
      <button type="submit" class="btn-sair-fila">Sair da fila</button>
    </form>
  </div>

  {% endif %}
  {% endif %}

  <!-- CASO 3: ANALISANDO -->
  {% if user_entry and user_entry.status == 'Analisando' %}
  <div class="analis-card">
    <div>
      <div class="card-chip chip-yellow">● ANALISANDO</div>
      <div style="font-size:0.78rem; color:var(--muted); margin-top:0.25rem;">Você está analisando uma demanda.</div>
    </div>
    <form action="{{ url_for('finish_task') }}" method="POST">
      <button type="submit" class="btn-yellow">FINALIZAR</button>
    </form>
  </div>
  {% endif %}

  <!-- FILA ATUAL -->
  <div class="sec-title">Fila atual</div>
  <div class="fila-list">
    {% if not queue %}
    <div class="fora-card" style="padding: 1.5rem;">
      <p style="margin-bottom: 0;">Ninguém na fila no momento.</p>
    </div>
    {% else %}
    {% for entry in queue %}
    <div class="fila-item
        {% if loop.first and entry.status == 'Disponível' %}vez{% endif %}
        {% if entry.status == 'Analisando' %}analisando{% endif %}
        {% if entry.user_id == current_user.id %}eu{% endif %}">

      <div class="fila-pos">{{ loop.index }}</div>

      <div class="fila-info">
        <div class="fila-nome">
          {{ entry.user.username }}
          {% if entry.user_id == current_user.id %}(Você){% endif %}
        </div>
        <div class="fila-status
            {% if entry.status == 'Disponível' and loop.first %}green{% endif %}
            {% if entry.status == 'Analisando' %}yellow{% endif %}">
          {% if loop.first and entry.status == 'Disponível' %}Na vez{% else %}{{ entry.status }}{% endif %}
        </div>
      </div>

      {% if entry.user_id == current_user.id %}
      <span class="badge-eu">você</span>
      {% endif %}

      {% if loop.first and entry.status == 'Disponível' %}
      <span class="badge-eu" style="background:var(--info-dim); color:var(--info)">NA VEZ</span>
      {% endif %}

    </div>
    {% endfor %}
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/sw.js')
      .then(r => console.log('SW registrado:', r.scope))
      .catch(e => console.log('SW falhou:', e));
  }

  var isMyTurn = {{ 'true' if turn_user and turn_user.user_id == current_user.id else 'false' }};

  if (isMyTurn) {
    if (!localStorage.getItem('notified_turn')) {
      var audio = document.getElementById('notificationSound');
      if (audio) audio.play().catch(() => { });

      if (Notification.permission === "granted") {
        var n = new Notification("Sua Vez!", {
          body: "É a sua vez na fila. Inicie sua tarefa.",
          icon: "https://cdn-icons-png.flaticon.com/512/1827/1827347.png"
        });
        n.onclick = () => window.focus();
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(p => {
          if (p === "granted") {
            var n = new Notification("Sua Vez!", {
              body: "É a sua vez na fila. Inicie sua tarefa.",
              icon: "https://cdn-icons-png.flaticon.com/512/1827/1827347.png"
            });
            n.onclick = () => window.focus();
          }
        });
      }
      localStorage.setItem('notified_turn', 'true');
    }
  } else {
    localStorage.removeItem('notified_turn');
  }
</script>
{% endblock %}