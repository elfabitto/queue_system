{% extends "base.html" %}

{% block extra_styles %}
<style>
  /* For√ßar a exibi√ß√£o do √≠cone do calend√°rio para inputs type="date" em temas escuros */
  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
    font-size: 1.2rem;
  }

  /* Admin Panel Specific Styles */
  .admin-main {
    max-width: 860px;
    margin: 0 auto;
    padding: 1.5rem 1rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.7rem;
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.9rem 1rem;
  }

  .stat-label {
    font-size: 0.68rem;
    color: var(--muted);
    margin-bottom: 0.25rem;
  }

  .stat-value {
    font-family: 'DM Mono', monospace;
    font-size: 1.75rem;
    font-weight: 300;
  }

  .stat-value.green {
    color: var(--accent);
  }

  .stat-value.blue {
    color: var(--info);
  }

  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.9rem;
    margin-bottom: 1.5rem;
  }

  /* Table */
  .admin-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
  }

  .admin-table th {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.08em;
    color: var(--muted);
    padding: 0.35rem 0.45rem;
    border-bottom: 1px solid var(--border);
    text-align: left;
  }

  .admin-table td {
    padding: 0.5rem 0.45rem;
    font-size: 0.8rem;
    border-bottom: 1px solid var(--border);
  }

  .admin-table tr:last-child td {
    border-bottom: none;
  }

  .status-badge {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.04em;
    padding: 0.12rem 0.4rem;
    border-radius: 4px;
  }

  .status-badge.aguardando {
    background: var(--muted2);
    color: var(--muted);
  }

  .status-badge.vez {
    background: var(--accent-dim);
    color: var(--accent);
  }

  .status-badge.analisando {
    background: var(--warn-dim);
    color: var(--warn);
  }

  /* Colab row */
  .colab-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
  }

  .colab-row:last-child {
    border-bottom: none;
  }

  .colab-nome {
    flex: 1;
    font-size: 0.82rem;
  }

  .colab-total {
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    color: var(--accent);
  }

  .colab-media {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    width: 65px;
    text-align: right;
  }

  /* Form */
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.6rem;
    margin-top: 0.75rem;
  }

  .form-group label {
    font-size: 0.65rem;
    letter-spacing: 0.07em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 0.28rem;
  }

  .form-group input {
    margin-bottom: 0;
  }

  .form-foot {
    display: flex;
    align-items: center;
    margin-top: 0.7rem;
  }

  .form-foot label {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.75rem;
    color: var(--muted);
    cursor: pointer;
    text-transform: none;
    letter-spacing: 0;
  }

  .btn-criar {
    margin-left: auto;
    padding: 0.5rem 1.1rem;
    background: var(--accent);
    color: #0d0d0f;
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.05em;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.18s;
  }

  .btn-criar:hover {
    opacity: 0.88;
  }

  .user-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
  }

  .user-row:last-child {
    border-bottom: none;
  }

  .u-nome {
    flex: 1;
    font-size: 0.82rem;
  }

  .u-email {
    font-size: 0.68rem;
    color: var(--muted);
  }

  .btn-rem {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    padding: 0.22rem 0.5rem;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.18s;
  }

  .btn-rem:hover {
    border-color: var(--danger);
    color: var(--danger);
  }

  .mb {
    margin-bottom: 1.5rem;
  }

  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .header-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .header-title h2 {
    font-size: 1.25rem;
    font-weight: 500;
  }

  .btn-link {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.05em;
    padding: 0.4rem 0.75rem;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.18s;
    text-decoration: none;
    display: inline-block;
  }

  .btn-link:hover {
    border-color: var(--info);
    color: var(--info);
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-main">

  <!-- Header -->
  <div class="header-row">
    <div class="header-title">
      <h2>Painel do Administrador</h2>
    </div>

    <!-- CSV Export Form -->
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <form action="{{ url_for('export_xlsx') }}" method="GET"
        style="display: flex; gap: 0.5rem; align-items: center; margin: 0;">
        <label style="font-size: 0.7rem; color: var(--muted);">In√≠cio:</label>
        <input type="date" name="start_date"
          style="padding: 0.3rem; font-size: 0.7rem; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; color: var(--fg);"
          required>

        <label style="font-size: 0.7rem; color: var(--muted); margin-left: 0.5rem;">Fim:</label>
        <input type="date" name="end_date"
          style="padding: 0.3rem; font-size: 0.7rem; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; color: var(--fg);"
          required>

        <button type="submit" class="btn-link" style="margin-left: 0.5rem;">üìä EXPORTAR XLSX</button>
      </form>
    </div>
  </div>

  <!-- Stats -->
  {% if stats %}
  <div class="sec-title">Atendimentos por colaborador</div>
  <div class="stats-grid mb">
    {% for stat in stats %}
    <div class="stat-card">
      <div class="stat-label">{{ stat.username }}</div>
      <div style="display: flex; gap: 1rem;">
        <div>
          <span style="font-size: 0.65rem; color: var(--muted);">Conclu√≠dos:</span>
          <div class="stat-value green">{{ stat.count }}</div>
        </div>
        <div>
          <span style="font-size: 0.65rem; color: var(--muted);">Pulados:</span>
          <div class="stat-value" style="color: var(--warn);">{{ stat.skip_count }}</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Daily Statistics -->
  {% if daily_stats %}
  <div class="sec-title">Atendimentos di√°rios por colaborador</div>
  <div class="card mb">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Colaborador</th>
          <th>Hoje</th>
          <th>Esta semana</th>
          <th>Este m√™s</th>
        </tr>
      </thead>
      <tbody>
        {% for stat in daily_stats %}
        <tr>
          <td>{{ stat.username }}</td>
          <td>
            <div>Con: <span class="stat-value blue">{{ stat.today }}</span></div>
            <div style="font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem;">Pul: <span
                style="color: var(--warn);">{{ stat.today_skips }}</span></div>
          </td>
          <td>
            <div>Con: <span class="stat-value green">{{ stat.this_week }}</span></div>
            <div style="font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem;">Pul: <span
                style="color: var(--warn);">{{ stat.week_skips }}</span></div>
          </td>
          <td>
            <div>Con: <span class="stat-value">{{ stat.this_month }}</span></div>
            <div style="font-size: 0.7rem; color: var(--muted); margin-top: 0.2rem;">Pul: <span
                style="color: var(--warn);">{{ stat.month_skips }}</span></div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- Two Columns: Fila + Hist√≥rico -->
  <div class="two-col mb">

    <!-- Fila Atual -->
    <div class="card">
      <div class="sec-title">Fila atual</div>
      <table class="admin-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Nome</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% if not queue %}
          <tr>
            <td colspan="3" style="text-align:center; color:var(--muted); padding: 1rem;">Ningu√©m na fila</td>
          </tr>
          {% else %}
          {% for entry in queue %}
          <tr>
            <td style="color:var(--muted);font-family:'DM Mono',monospace">{{ loop.index }}</td>
            <td>{{ entry.user.username if entry.user else 'Desconhecido' }}</td>
            <td>
              {% if loop.first and entry.status == 'Dispon√≠vel' %}
              <span class="status-badge vez">Na vez</span>
              {% elif entry.status == 'Analisando' %}
              <span class="status-badge analisando">Analisando</span>
              {% else %}
              <span class="status-badge aguardando">Dispon√≠vel</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Hist√≥rico Recente -->
    <div class="card">
      <div class="sec-title">√öltimos atendimentos</div>
      <div style="max-height: 380px; overflow-y: auto; padding-right: 5px;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Dura√ß√£o</th>
            </tr>
          </thead>
          <tbody>
            {% if not history %}
            <tr>
              <td colspan="2" style="text-align:center; color:var(--muted); padding: 1rem;">Nenhum atendimento</td>
            </tr>
            {% else %}
            {% for record in history %}
            <tr>
              <td>{{ record.colaborador.username }}</td>
              <td>
                <span style="font-family:'DM Mono',monospace; font-size:0.72rem;">
                  {{ record.duracao }}
                </span>
              </td>
            </tr>
            {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Gerenciar Usu√°rios -->
  <div class="sec-title">Gerenciar colaboradores</div>
  <div class="card">
    <!-- Lista de Usu√°rios -->
    {% for user in all_users %}
    <div class="user-row">
      <div>
        <div class="u-nome">
          {{ user.username }}
          {% if user.is_admin %}
          <span class="admin-badge" style="margin-left: 0.5rem;">ADMIN</span>
          {% endif %}
        </div>
        <div class="u-email">{{ user.email }}</div>
      </div>
      <div style="display: flex; gap: 0.5rem;">
        {% if not user.is_admin %}
        <a href="{{ url_for('view_colaborador', user_id=user.id) }}" class="btn-link"
          style="padding: 0.22rem 0.5rem;">DETALHES</a>
        {% endif %}
        {% if user.id != current_user.id %}
        <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST"
          onsubmit="return confirm('Tem certeza que deseja remover este usu√°rio?')" style="margin:0;">
          <button type="submit" class="btn-rem">REMOVER</button>
        </form>
        {% else %}
        <span style="font-size: 0.65rem; color: var(--muted); font-style: italic; align-self: center;">Voc√™</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}

    <!-- Formul√°rio de Cria√ß√£o -->
    <div style="border-top: 1px solid var(--border); margin-top: 0.75rem; padding-top: 0.9rem;">
      <div class="sec-title">Adicionar colaborador</div>
      <form action="{{ url_for('create_user') }}" method="POST">
        <div class="form-row">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" name="username" placeholder="Nome completo" required>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" placeholder="email@empresa.com" required>
          </div>
          <div class="form-group">
            <label>Senha</label>
            <input type="password" name="password" placeholder="Senha inicial" required>
          </div>
        </div>
        <div class="form-foot">
          <label style="display: flex; align-items: center; gap: 0.35rem;">
            <input type="checkbox" name="is_admin" id="is_admin" style="width: auto;">
            <span>Admin</span>
          </label>
          <button type="submit" class="btn-criar">CRIAR USU√ÅRIO</button>
        </div>
      </form>
    </div>
  </div>

</div>
{% endblock %}